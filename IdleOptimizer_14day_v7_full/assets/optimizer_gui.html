<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Upgrade Optimizer — Settings GUI (v7 — 14-day event)</title>
  <style>
    :root { --bg:#0b0f14; --card:#121822; --ink:#e8f0ff; --muted:#9db0c9; --acc:#5cc8ff; }
    html,body{height:100%}
    body{margin:0;background:linear-gradient(180deg,#0b0f14,#0e141c 40%,#0b0f14);color:var(--ink);font-family:system-ui,Segoe UI,Roboto,Inter,Arial,sans-serif}
    .wrap{max-width:1100px;margin:24px auto;padding:16px}
    .card{background:var(--card);border:1px solid #1c2533;border-radius:14px;padding:16px;margin-bottom:16px;box-shadow:0 10px 30px rgba(0,0,0,.35)}
    .grid{display:grid;grid-template-columns:1fr 1fr;gap:12px}
    .row{display:grid;grid-template-columns: 260px 1fr;align-items:center;gap:8px;margin:6px 0}
    .resgrid{display:grid;grid-template-columns:repeat(4,1fr);gap:8px}
    .upgrid{display:grid;grid-template-columns:repeat(5,1fr);gap:8px}
    .tabs{display:flex;gap:6px;margin:6px 0 14px}
    .tab{padding:8px 12px;border:1px solid #1c2533;border-radius:10px;background:#0c131d;cursor:pointer}
    .tab.active{outline:2px solid #5cc8ff}
    .hidden{display:none}
    .muted{color:var(--muted);font-size:.95rem}
    .pill{display:inline-block;padding:.2rem .5rem;border:1px solid #2a3b53;border-radius:999px;margin:.1rem .2rem;font-size:.85rem;color:#cfe2ff}
    input, textarea{width:100%;box-sizing:border-box;background:#0b111a;color:var(--ink);border:1px solid #223048;border-radius:10px;padding:10px 12px;font-family:ui-monospace,Consolas,monospace}
    textarea{min-height:72px}
    button{background:linear-gradient(180deg,#1c88ff,#1460ff);border:none;color:white;padding:10px 14px;border-radius:10px;font-weight:600;cursor:pointer}
    button.secondary{background:#1a2331}
  </style>
</head>
<body>
  <div class="wrap">
    <h1>Upgrade Optimizer — Settings GUI (v7 — 14-day event)</h1>
    <div class="tabs">
      <div class="tab active" id="tabMainBtn">Main</div>
      <div class="tab" id="tabNamesBtn">Resource Names</div>
    </div>

    <div class="card">
      <p class="muted">Edit values, then <b>Save JSON</b>. Use <b>Load JSON</b> to continue later.</p>
      <div style="display:flex;gap:10px;margin:8px 0 4px">
        <button id="loadBtn">Load JSON...</button>
        <button id="saveBtn">Save JSON</button>
      </div>
      <div id="status" class="muted"></div>
    </div>

    <div id="tabMain">
      <div class="card">
        <h2>Scalars</h2>
        <div class="grid">
          <div>
            <div class="row"><label>EVENT_DURATION_DAYS</label><input id="EVENT_DURATION_DAYS" type="number" value="14"></div>
            <div class="row"><label>EVENT_DURATION_HOURS</label><input id="EVENT_DURATION_HOURS" type="number" value="0"></div>
            <div class="row"><label>EVENT_DURATION_MINUTES</label><input id="EVENT_DURATION_MINUTES" type="number" value="0"></div>
            <div class="row"><label>EVENT_DURATION_SECONDS</label><input id="EVENT_DURATION_SECONDS" type="number" value="0"></div>
            <div class="row"><label>UNLOCKED_PETS</label><input id="UNLOCKED_PETS" type="number" value="100"></div>
            <div class="row"><label>DLs</label><input id="DLs" type="number" value="0"></div>
          </div>
          <div>
            <div class="row"><label>outputInterval (ms)</label><input id="outputInterval" type="number" value="5000"></div>
            <div class="row"><label>EVENT_CURRENCY_WEIGHT</label><input id="EVENT_CURRENCY_WEIGHT" type="number" step="any" value="0.001"></div>
            <div class="row"><label>FREE_EXP_WEIGHT</label><input id="FREE_EXP_WEIGHT" type="number" step="any" value="0.00006"></div>
            <div class="row"><label>PET_STONES_WEIGHT</label><input id="PET_STONES_WEIGHT" type="number" step="any" value="0.000045"></div>
            <div class="row"><label>GROWTH_WEIGHT</label><input id="GROWTH_WEIGHT" type="number" step="any" value="0.00007"></div>
            <div class="row"><label>Flags</label>
              <div>
                <label><input type="checkbox" id="isFullPath" checked> isFullPath</label>
                <label style="margin-left:10px"><input type="checkbox" id="allowSpeedUpgrades" checked> allowSpeedUpgrades</label>
                <label style="margin-left:10px"><input type="checkbox" id="runOptimization" checked> runOptimization</label>
              </div>
            </div>
          </div>
        </div>
      </div>

      <div class="card">
        <h2>Resources (starting counts)</h2>
        <p class="muted">Defaults: all 0 except <b>Bat=500000</b>, <b>FREE_EXP=1</b>, <b>GROWTH=1</b>.</p>
        <div class="resgrid">
          <div><label id="labRes0">0 — Tomb</label><input id="res0" type="number" step="any" value="0"></div>
          <div><label id="labRes1">1 — Bat</label><input id="res1" type="number" step="any" value="500000"></div>
          <div><label id="labRes2">2 — Ghost</label><input id="res2" type="number" step="any" value="0"></div>
          <div><label id="labRes3">3 — Witch_Book</label><input id="res3" type="number" step="any" value="0"></div>
          <div><label id="labRes4">4 — Witch_Soup</label><input id="res4" type="number" step="any" value="0"></div>
          <div><label id="labRes5">5 — Eye</label><input id="res5" type="number" step="any" value="0"></div>
          <div><label id="labRes6">6 — PET_STONES</label><input id="res6" type="number" step="any" value="0"></div>
          <div><label id="labRes9">9 — Black_Cat</label><input id="res9" type="number" step="any" value="0"></div>
        </div>
        <div style="margin-top:10px" class="muted">
          <label><input type="checkbox" id="overrideFreeExp" checked> Override FREE_EXP (7)</label>
          <input id="res7" type="number" step="any" value="1" style="width:120px;margin-left:10px">
          <br>
          <label><input type="checkbox" id="overrideGrowth" checked> Override GROWTH (8)</label>
          <input id="res8" type="number" step="any" value="1" style="width:120px;margin-left:10px">
          <div style="margin-top:8px">
            <span>Computed if not overridden:</span>
            <span id="freeExpVal"></span> (FREE_EXP), <span id="growthVal"></span> (GROWTH)
          </div>
        </div>
        <div class="btns" style="margin-top:10px;display:flex;gap:8px">
          <button id="syncFromResources">Sync → resourceCounts CSV</button>
          <button class="secondary" id="syncToResources">Parse resourceCounts → fields</button>
        </div>
      </div>

      <div class="card">
        <h2>Upgrades — levels & speeds</h2>
        <div id="legend" class="muted" style="margin-bottom:8px"></div>
        <h3>Starting Levels</h3>
        <div class="upgrid" id="levelGrid"></div>
        <h3>Speed Levels</h3>
        <div class="upgrid" id="speedGrid"></div>
        <div class="row"><label>Dummy placeholder (index 20)</label><input id="dummyLevel" type="number" value="0"></div>
        <div class="btns" style="display:flex;gap:8px">
          <button id="syncFromGrids">Sync → currentLevels CSV</button>
          <button class="secondary" id="syncToGrids">Parse currentLevels → grids</button>
        </div>
      </div>

      <div class="card">
        <h2>Vectors (CSV)</h2>
        <div class="row"><label>currentLevels</label><textarea id="currentLevels">0,0,0,0,0,0,0,0,0,0, 0,0,0,0,0,0,0,0,0,0, 0</textarea></div>
        <div class="row"><label>resourceCounts</label><textarea id="resourceCounts">0, 500000, 0, 0, 0, 0, 0, 1, 1, 0</textarea></div>
        <div class="row"><label>upgradePath</label><textarea id="upgradePath" placeholder="(optional)"></textarea></div>
        <div class="row"><label>busyTimesStart (hours)</label><textarea id="busyTimesStart" placeholder=""></textarea></div>
        <div class="row"><label>busyTimesEnd (hours)</label><textarea id="busyTimesEnd" placeholder=""></textarea></div>
      </div>
    </div>

    <div id="tabNames" class="hidden">
      <div class="card">
        <h2>Resource Names</h2>
        <p class="muted">Rename resources here for each event. Saved as <code>resourceNames</code> in JSON.</p>
        <div class="upgrid" id="namesGrid"></div>
        <div style="margin-top:10px" class="muted">
          <span class="pill">0..9 = Level</span>
          <span class="pill">10..19 = Speed</span>
          <span class="pill">20 = Complete</span>
        </div>
      </div>
    </div>

    <input id="fileInput" type="file" accept="application/json" style="display:none" />
  </div>

  <script>
    function $(id){ return document.getElementById(id); }
    let resourceNames = ['Tomb','Bat','Ghost','Witch_Book','Witch_Soup','Eye','PET_STONES','FREE_EXP','GROWTH','Black_Cat'];

    const tabMainBtn = $('tabMainBtn'), tabNamesBtn = $('tabNamesBtn');
    const tabMain = $('tabMain'), tabNames = $('tabNames');
    tabMainBtn.onclick = () => { tabMainBtn.classList.add('active'); tabNamesBtn.classList.remove('active'); tabMain.classList.remove('hidden'); tabNames.classList.add('hidden'); };
    tabNamesBtn.onclick = () => { tabNamesBtn.classList.add('active'); tabMainBtn.classList.remove('active'); tabNames.classList.remove('hidden'); tabMain.classList.add('hidden'); };

    function buildNamesGrid(){
      const ng = $('namesGrid'); ng.innerHTML='';
      for(let i=0;i<10;i++){
        const wrap = document.createElement('div');
        wrap.innerHTML = `<label class="muted" style="display:block;font-size:.85rem;margin-bottom:4px">${i} — Name</label>
                          <input id="name${i}" type="text" value="${resourceNames[i]}">`;
        ng.appendChild(wrap);
      }
      for(let i=0;i<10;i++){
        const input = document.getElementById('name'+i);
        input.addEventListener('input', () => {
          resourceNames[i] = input.value || ('Res'+i);
          refreshResourceLabels();
          buildUpgradeGrids();
        });
      }
    }
    function refreshResourceLabels(){
      $('labRes0').textContent = `0 — ${resourceNames[0]}`;
      $('labRes1').textContent = `1 — ${resourceNames[1]}`;
      $('labRes2').textContent = `2 — ${resourceNames[2]}`;
      $('labRes3').textContent = `3 — ${resourceNames[3]}`;
      $('labRes4').textContent = `4 — ${resourceNames[4]}`;
      $('labRes5').textContent = `5 — ${resourceNames[5]}`;
      $('labRes6').textContent = `6 — ${resourceNames[6]}`;
      $('labRes9').textContent = `9 — ${resourceNames[9]}`;
      buildLegend();
    }
    function buildLegend(){
      const frag = [];
      for(let i=0;i<10;i++) frag.push('<span class="pill">'+i+' = '+resourceNames[i]+' (Level)</span>');
      for(let i=0;i<10;i++) frag.push('<span class="pill">'+(10+i)+' = '+resourceNames[i]+' (Speed)</span>');
      frag.push('<span class="pill">20 = Complete</span>');
      document.getElementById('legend').innerHTML = frag.join(' ');
    }
    function buildUpgradeGrids(){
      const lg = document.getElementById('levelGrid'); const sg = document.getElementById('speedGrid');
      lg.innerHTML=''; sg.innerHTML='';
      for(let i=0;i<10;i++){
        const wrap = document.createElement('div');
        wrap.innerHTML = '<label class="muted" style="display:block;font-size:.85rem;margin-bottom:4px)">'+i+' — '+resourceNames[i]+' (Level)</label>'+
                         '<input id="lvl'+i+'" type="number" value="0">';
        lg.appendChild(wrap);
      }
      for(let i=0;i<10;i++){
        const idx=10+i; const wrap = document.createElement('div');
        wrap.innerHTML = '<label class="muted" style="display:block;font-size:.85rem;margin-bottom:4px)">'+idx+' — '+resourceNames[i]+' (Speed)</label>'+
                         '<input id="spd'+idx+'" type="number" value="0">';
        sg.appendChild(wrap);
      }
    }

    function isAllowedExpr(expr){
      const extra = '0123456789+-*/()., ';
      for(let i=0;i<expr.length;i++){
        const c = expr[i];
        const code = c.charCodeAt(0);
        const isLetter = (code>=65 && code<=90) || (code>=97 && code<=122) || c==='_' ;
        if (extra.indexOf(c)===-1 && !isLetter) return false;
      }
      return true;
    }
    function evalExpr(expr, vars){
      const keys = Object.keys(vars);
      const vals = Object.values(vars);
      const fn = new Function(keys.join(','), 'return ('+expr+');');
      return fn.apply(null, vals);
    }
    function parseCSVInts(text, vars){
      if(!text.trim()) return [];
      return text.split(',').map(s=>{
        const t = s.trim(); if(!t) return null;
        const v = isAllowedExpr(t) ? evalExpr(t, vars) : t;
        const n = Number(v);
        if(!isFinite(n)) throw new Error('Invalid int: '+t);
        return Math.trunc(n);
      }).filter(x=>x!==null);
    }
    function parseCSVNums(text, vars){
      if(!text.trim()) return [];
      return text.split(',').map(s=>{
        const t = s.trim(); if(!t) return null;
        const v = isAllowedExpr(t) ? evalExpr(t, vars) : t;
        const n = Number(v);
        if(!isFinite(n)) throw new Error('Invalid number: '+t);
        return n;
      }).filter(x=>x!==null);
    }

    function getScalars(){
      return {
        EVENT_DURATION_DAYS: +document.getElementById('EVENT_DURATION_DAYS').value,
        EVENT_DURATION_HOURS: +document.getElementById('EVENT_DURATION_HOURS').value,
        EVENT_DURATION_MINUTES: +document.getElementById('EVENT_DURATION_MINUTES').value,
        EVENT_DURATION_SECONDS: +document.getElementById('EVENT_DURATION_SECONDS').value,
        UNLOCKED_PETS: +document.getElementById('UNLOCKED_PETS').value,
        DLs: +document.getElementById('DLs').value,
        outputInterval: +document.getElementById('outputInterval').value,
        EVENT_CURRENCY_WEIGHT: +document.getElementById('EVENT_CURRENCY_WEIGHT').value,
        FREE_EXP_WEIGHT: +document.getElementById('FREE_EXP_WEIGHT').value,
        PET_STONES_WEIGHT: +document.getElementById('PET_STONES_WEIGHT').value,
        GROWTH_WEIGHT: +document.getElementById('GROWTH_WEIGHT').value,
        isFullPath: document.getElementById('isFullPath').checked,
        allowSpeedUpgrades: document.getElementById('allowSpeedUpgrades').checked,
        runOptimization: document.getElementById('runOptimization').checked,
      };
    }
    function computedFreeExp(DLs){ return 1/((500+DLs)/5); }
    function computedGrowth(UNLOCKED_PETS){ return 1/(UNLOCKED_PETS/100); }
    function updateComputed(){
      document.getElementById('freeExpVal').textContent = computedFreeExp(+document.getElementById('DLs').value||0).toFixed(6);
      document.getElementById('growthVal').textContent  = computedGrowth(+document.getElementById('UNLOCKED_PETS').value||0).toFixed(6);
    }

    function readResourcesFromGrid(){
      const arr = new Array(10);
      arr[0] = +document.getElementById('res0').value || 0;
      arr[1] = +document.getElementById('res1').value || 0;
      arr[2] = +document.getElementById('res2').value || 0;
      arr[3] = +document.getElementById('res3').value || 0;
      arr[4] = +document.getElementById('res4').value || 0;
      arr[5] = +document.getElementById('res5').value || 0;
      arr[6] = +document.getElementById('res6').value || 0;
      arr[7] = +document.getElementById('res7').value || 1;
      arr[8] = +document.getElementById('res8').value || 1;
      arr[9] = +document.getElementById('res9').value || 0;
      return arr;
    }
    function writeResourcesToGrid(list){
      if(!Array.isArray(list) || list.length<10) return;
      document.getElementById('res0').value = list[0] ?? 0;
      document.getElementById('res1').value = list[1] ?? 0;
      document.getElementById('res2').value = list[2] ?? 0;
      document.getElementById('res3').value = list[3] ?? 0;
      document.getElementById('res4').value = list[4] ?? 0;
      document.getElementById('res5').value = list[5] ?? 0;
      document.getElementById('res6').value = list[6] ?? 0;
      document.getElementById('res7').value = list[7] ?? 1;
      document.getElementById('res8').value = list[8] ?? 1;
      document.getElementById('res9').value = list[9] ?? 0;
      updateComputed();
    }

    function gather(){
      const s = getScalars();
      const vars = { DLs: s.DLs, UNLOCKED_PETS: s.UNLOCKED_PETS };
      const res = readResourcesFromGrid();
      const currentLevels = parseCSVInts(document.getElementById('currentLevels').value, vars);
      const upgradePath = parseCSVInts(document.getElementById('upgradePath').value, vars);
      const bts = parseCSVNums(document.getElementById('busyTimesStart').value, vars);
      const bte = parseCSVNums(document.getElementById('busyTimesEnd').value, vars);
      const names = [];
      for(let i=0;i<10;i++){ names.push( document.getElementById('name'+i).value || ('Res'+i) ); }
      return Object.assign({}, s, {
        currentLevels, resourceCounts: res, upgradePath,
        busyTimesStart: bts, busyTimesEnd: bte,
        resourceNames: names
      });
    }
    function populate(data){
      function set(id, v){ const el = document.getElementById(id); if(el && el.type==='checkbox') el.checked=!!v; else if(el) el.value = v; }
      set('EVENT_DURATION_DAYS', data.EVENT_DURATION_DAYS ?? 14);
      set('EVENT_DURATION_HOURS', data.EVENT_DURATION_HOURS ?? 0);
      set('EVENT_DURATION_MINUTES', data.EVENT_DURATION_MINUTES ?? 0);
      set('EVENT_DURATION_SECONDS', data.EVENT_DURATION_SECONDS ?? 0);
      set('UNLOCKED_PETS', data.UNLOCKED_PETS ?? 100);
      set('DLs', data.DLs ?? 0);
      set('outputInterval', data.outputInterval ?? 5000);
      set('EVENT_CURRENCY_WEIGHT', data.EVENT_CURRENCY_WEIGHT ?? 0.001);
      set('FREE_EXP_WEIGHT', data.FREE_EXP_WEIGHT ?? 0.00006);
      set('PET_STONES_WEIGHT', data.PET_STONES_WEIGHT ?? 0.000045);
      set('GROWTH_WEIGHT', data.GROWTH_WEIGHT ?? 0.00007);
      set('isFullPath', data.isFullPath ?? true);
      set('allowSpeedUpgrades', data.allowSpeedUpgrades ?? true);
      set('runOptimization', data.runOptimization ?? true);

      if (Array.isArray(data.resourceNames) && data.resourceNames.length>=10){
        resourceNames = data.resourceNames.slice(0,10);
      }
      buildNamesGrid();
      refreshResourceLabels();
      buildUpgradeGrids();

      document.getElementById('currentLevels').value = (data.currentLevels || Array(21).fill(0)).join(', ');
      document.getElementById('resourceCounts').value = (data.resourceCounts || [0,500000,0,0,0,0,0,1,1,0]).join(', ');
      document.getElementById('upgradePath').value = (data.upgradePath || []).join(', ');
      document.getElementById('busyTimesStart').value = (data.busyTimesStart || []).join(', ');
      document.getElementById('busyTimesEnd').value = (data.busyTimesEnd || []).join(', ');

      writeResourcesToGrid(data.resourceCounts || [0,500000,0,0,0,0,0,1,1,0]);
    }

    function setStatus(msg, ok){
      const el = document.getElementById('status');
      el.textContent = msg;
      el.style.color = ok? '#b1ffb1' : '#ff9b9b';
    }
    document.getElementById('saveBtn').onclick = () => {
      try {
        const data = gather();
        const blob = new Blob([JSON.stringify(data,null,2)],{type:'application/json'});
        const a = document.createElement('a');
        a.href = URL.createObjectURL(blob);
        a.download = 'config.json';
        a.click();
        URL.revokeObjectURL(a.href);
        setStatus('Saved config.json', true);
      } catch(e){ setStatus(e.message,false); }
    };
    document.getElementById('loadBtn').onclick = () => {
      const inp = document.createElement('input');
      inp.type = 'file'; inp.accept = 'application/json';
      inp.onchange = () => {
        const f = inp.files[0]; if(!f) return;
        const fr = new FileReader();
        fr.onload = () => { try { populate(JSON.parse(fr.result)); setStatus('Loaded '+f.name,true);} catch(e){ setStatus('Invalid JSON: '+e.message,false);} };
        fr.readAsText(f);
      };
      inp.click();
    };

    // init
    buildNamesGrid();
    refreshResourceLabels();
    buildUpgradeGrids();
    populate({
      currentLevels: Array(21).fill(0),
      resourceCounts: [0,500000,0,0,0,0,0,1,1,0],
      resourceNames: resourceNames
    });
  </script>
</body>
</html>